apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cluster-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    release: kube-prometheus-stack
spec:
  groups:
    - name: node-alerts
      rules:
        - alert: NodeDown
          expr: up{job="node-exporter"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Node {{ $labels.instance }} is down"
            description: "Node exporter on {{ $labels.instance }} has been down for more than 5 minutes."

        - alert: NodeHighCPU
          expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on {{ $labels.instance }}"
            description: "CPU usage is above 80% for more than 10 minutes."

        - alert: NodeHighMemory
          expr: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage on {{ $labels.instance }}"
            description: "Memory usage is above 85% for more than 10 minutes."

        - alert: NodeDiskAlmostFull
          expr: (1 - node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes) * 100 > 85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Disk almost full on {{ $labels.instance }}"
            description: "Disk {{ $labels.mountpoint }} is above 85% full."

    - name: kubernetes-alerts
      rules:
        - alert: PodCrashLooping
          expr: increase(kube_pod_container_status_restarts_total[1h]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
            description: "Pod has restarted more than 3 times in the last hour."

        - alert: PodNotReady
          expr: kube_pod_status_ready{condition="true"} == 0
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
            description: "Pod has been in a non-ready state for more than 15 minutes."

        - alert: DeploymentReplicasMismatch
          expr: kube_deployment_status_replicas_available != kube_deployment_spec_replicas
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has replica mismatch"
            description: "Deployment does not have expected number of replicas."

        - alert: PVCAlmostFull
          expr: kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes < 0.15
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is almost full"
            description: "PVC has less than 15% space remaining."

        - alert: PVCCriticallyFull
          expr: kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes < 0.05
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is critically full"
            description: "PVC has less than 5% space remaining."

    - name: certificate-alerts
      rules:
        - alert: CertificateExpiringSoon
          expr: certmanager_certificate_expiration_timestamp_seconds - time() < 604800
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "Certificate {{ $labels.namespace }}/{{ $labels.name }} expires in less than 7 days"
            description: "Certificate will expire in {{ $value | humanizeDuration }}."

        - alert: CertificateExpiryCritical
          expr: certmanager_certificate_expiration_timestamp_seconds - time() < 86400
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: "Certificate {{ $labels.namespace }}/{{ $labels.name }} expires in less than 24 hours"
            description: "Certificate will expire in {{ $value | humanizeDuration }}."

    - name: flux-alerts
      rules:
        - alert: FluxReconciliationFailure
          expr: gotk_reconcile_condition{status="False",type="Ready"} == 1
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Flux {{ $labels.kind }}/{{ $labels.name }} reconciliation failing"
            description: "{{ $labels.kind }} {{ $labels.namespace }}/{{ $labels.name }} has been failing for 15 minutes."

    - name: proxmox-alerts
      rules:
        - alert: ProxmoxNodeDown
          expr: up{job="proxmox-node-exporter"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Proxmox host {{ $labels.instance }} is unreachable"
            description: "node_exporter on Proxmox host {{ $labels.instance }} has been down for more than 5 minutes."

        - alert: ProxmoxHighTemperature
          expr: node_hwmon_temp_celsius{job="proxmox-node-exporter"} > 85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High temperature on Proxmox host {{ $labels.instance }}"
            description: "Sensor {{ $labels.chip }}/{{ $labels.sensor }} on {{ $labels.instance }} is at {{ $value }}C."

        - alert: ProxmoxCriticalTemperature
          expr: node_hwmon_temp_celsius{job="proxmox-node-exporter"} > 95
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Critical temperature on Proxmox host {{ $labels.instance }}"
            description: "Sensor {{ $labels.chip }}/{{ $labels.sensor }} on {{ $labels.instance }} is at {{ $value }}C. Immediate attention required."

    - name: storage-alerts
      rules:
        - alert: CephHealthWarning
          expr: ceph_health_status == 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Ceph cluster health warning"
            description: "Ceph cluster is in HEALTH_WARN state."

        - alert: CephHealthCritical
          expr: ceph_health_status == 2
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Ceph cluster health critical"
            description: "Ceph cluster is in HEALTH_ERR state."
