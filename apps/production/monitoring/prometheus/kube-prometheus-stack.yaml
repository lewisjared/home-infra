# kube-prometheus-stack HelmRelease
# This includes Prometheus, AlertManager, Grafana, and related components
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: monitoring
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: ">=79.0.0 <80.0.0" # Pin to v79.x (latest stable)
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: monitoring
      interval: 12h
  # Installation options
  install:
    createNamespace: false # Namespace created by infrastructure kustomization
    remediation:
      retries: 3
  # Upgrade options
  upgrade:
    force: true
    remediation:
      retries: 3
      remediateLastFailure: true
    cleanupOnFail: true
  # Uninstall options
  uninstall:
    keepHistory: false
  # Rollback on failure
  rollback:
    recreate: true
    cleanupOnFail: true
  # Values override
  values:
    # CRD Management - Enable automated CRD updates for chart upgrades
    crds:
      enabled: true
      upgradeJob:
        enabled: true

    # Global settings
    fullnameOverride: prometheus

    # Prometheus configuration
    prometheus:
      prometheusSpec:
        # Enable remote write receiver for k8s-monitoring (Alloy)
        enableRemoteWriteReceiver: true

        # Resource limits for Prometheus
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 2000m
            memory: 4Gi

        # Retention settings
        retention: 30d
        retentionSize: "45GB"

        # Storage configuration
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: rook-ceph-block
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 50Gi

        # Service monitor selector (monitor all ServiceMonitors)
        serviceMonitorSelectorNilUsesHelmValues: false
        podMonitorSelectorNilUsesHelmValues: false

        additionalScrapeConfigs: {}

    # Grafana configuration
    grafana:
      enabled: true
      admin:
        existingSecret: grafana-admin-credentials
        userKey: admin-user
        passwordKey: admin-password

      # Use Recreate strategy for RWO PVC
      deploymentStrategy:
        type: Recreate

      # Sidecar configuration - ensure datasources reload on startup
      sidecar:
        datasources:
          skipReload: false

      # Pod annotations for Reloader
      podAnnotations:
        configmap.reloader.stakater.com/reload: "prometheus-grafana-datasource"

      # Resource limits for Grafana
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

      # Persistence for Grafana dashboards
      persistence:
        enabled: true
        storageClassName: rook-ceph-block
        size: 10Gi

      # Grafana datasources with trace-log correlation
      prune: true
      additionalDataSources:
        - name: Loki
          type: loki
          url: http://loki.monitoring.svc.cluster.local:3100
          access: proxy
          isDefault: false
          jsonData:
            derivedFields:
              - datasourceUid: tempo
                matcherRegex: '"traceId":"([a-f0-9]+)"'
                name: TraceID
                url: "$${__value.raw}"
        - name: Tempo
          type: tempo
          url: http://tempo.monitoring.svc.cluster.local:3200
          access: proxy
          isDefault: false
          uid: tempo
          jsonData:
            tracesToLogsV2:
              datasourceUid: loki
              spanStartTimeShift: "-1h"
              spanEndTimeShift: "1h"
              filterByTraceID: true
              filterBySpanID: false
            tracesToMetrics:
              datasourceUid: prometheus
              spanStartTimeShift: "-1h"
              spanEndTimeShift: "1h"
            serviceMap:
              datasourceUid: prometheus
            nodeGraph:
              enabled: true
            lokiSearch:
              datasourceUid: loki

      # Grafana configuration
      grafana.ini:
        analytics:
          check_for_updates: false
        security:
          allow_embedding: true
        server:
          root_url: "https://grafana.home.lewelly.com"
        auth.generic_oauth:
          enabled: true
          name: Authelia
          client_id: grafana
          scopes: openid profile email groups
          # auth_url is browser-side, must be external
          auth_url: https://auth.home.lewelly.com/api/oidc/authorization
          # token_url and api_url are server-side, use internal service
          token_url: http://authelia.authelia.svc.cluster.local/api/oidc/token
          api_url: http://authelia.authelia.svc.cluster.local/api/oidc/userinfo
          login_attribute_path: preferred_username
          groups_attribute_path: groups
          role_attribute_path: "contains(groups[*], 'admins') && 'Admin' || 'Viewer'"
          allow_sign_up: true

      # Load OIDC secret from environment
      envFromSecrets:
        - name: grafana-oidc-secret

    # AlertManager configuration
    alertmanager:
      enabled: true
      config:
        global:
          resolve_timeout: 5m
        route:
          group_by: ["alertname", "namespace"]
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
          receiver: "pushover-critical"
          routes:
            - receiver: "pushover-critical"
              matchers:
                - severity = critical
            - receiver: "pushover-warning"
              matchers:
                - severity = warning
        receivers:
          - name: "pushover-critical"
            pushover_configs:
              - user_key_file: /etc/alertmanager/secrets/alertmanager-pushover/user_key
                token_file: /etc/alertmanager/secrets/alertmanager-pushover/api_token
                priority: 1
                title: "[CRITICAL] {{ .GroupLabels.alertname }}"
          - name: "pushover-warning"
            pushover_configs:
              - user_key_file: /etc/alertmanager/secrets/alertmanager-pushover/user_key
                token_file: /etc/alertmanager/secrets/alertmanager-pushover/api_token
                priority: 0
                title: "[WARNING] {{ .GroupLabels.alertname }}"
        inhibit_rules:
          - source_matchers:
              - severity = critical
            target_matchers:
              - severity = warning
            equal: ["alertname", "namespace"]
      alertmanagerSpec:
        secrets:
          - alertmanager-pushover
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: rook-ceph-block
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 10Gi

    # Re-enable kube-state-metrics for proper dashboard/recording rule integration
    kubeStateMetrics:
      enabled: true

    # Keep node-exporter disabled - using k8s-monitoring's version
    nodeExporter:
      enabled: false

    # Prometheus Operator settings
    prometheusOperator:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi
