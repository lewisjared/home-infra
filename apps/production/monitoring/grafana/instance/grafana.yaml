---
apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: grafana
  namespace: monitoring
  labels:
    grafana.internal/instance: grafana
spec:
  # Grafana configuration (grafana.ini equivalent)
  config:
    server:
      root_url: https://grafana.home.lewelly.com
    security:
      allow_embedding: "true"
    analytics:
      check_for_updates: "false"
    # Authelia OIDC authentication
    auth.generic_oauth:
      enabled: "true"
      name: Authelia
      client_id: grafana
      scopes: openid profile email groups
      # auth_url is browser-side, must be external
      auth_url: https://auth.home.lewelly.com/api/oidc/authorization
      # token_url and api_url are server-side, use internal service
      token_url: http://authelia.authelia.svc.cluster.local/api/oidc/token
      api_url: http://authelia.authelia.svc.cluster.local/api/oidc/userinfo
      login_attribute_path: preferred_username
      groups_attribute_path: groups
      role_attribute_path: contains(groups[*], 'admins') && 'Admin' || 'Viewer'
      allow_sign_up: "true"

  # Deployment configuration
  deployment:
    spec:
      replicas: 1
      strategy:
        type: Recreate
      template:
        spec:
          securityContext:
            runAsNonRoot: true
            runAsUser: 472
            fsGroup: 472
          containers:
            - name: grafana
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
              # Load admin password from secret
              env:
                - name: GF_SECURITY_ADMIN_USER
                  valueFrom:
                    secretKeyRef:
                      name: grafana-admin-credentials
                      key: admin-user
                - name: GF_SECURITY_ADMIN_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: grafana-admin-credentials
                      key: admin-password
              # Load OIDC client secret from secret
              envFrom:
                - secretRef:
                    name: grafana-oidc-secret

  # Service configuration
  service:
    spec:
      type: ClusterIP
      ports:
        - name: grafana
          port: 3000
          protocol: TCP
          targetPort: 3000

  # Persistent storage
  persistentVolumeClaim:
    spec:
      storageClassName: rook-ceph-block
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
