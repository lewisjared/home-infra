---
# Allow Alloy to send metrics to Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-alloy-to-prometheus
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: prometheus
  policyTypes:
    - Ingress
  ingress:
    - from:
        # Match all Alloy components (alloy-metrics, alloy-logs, alloy-singleton, etc.)
        - podSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - alloy
                  - alloy-metrics
                  - alloy-logs
                  - alloy-singleton
                  - alloy-receiver
      ports:
        - protocol: TCP
          port: 9090 # Prometheus remote write
# ---
# # Allow Prometheus and Alloy to scrape metrics from vela-trading namespace
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: allow-prometheus-scraping
#   namespace: vela-trading
# spec:
#   podSelector:
#     matchLabels:
#       app.kubernetes.io/part-of: home-infra
#   policyTypes:
#     - Ingress
#   ingress:
#     - from:
#         - namespaceSelector:
#             matchLabels:
#               name: monitoring
#           podSelector:
#             matchLabels:
#               app: prometheus
#         - namespaceSelector:
#             matchLabels:
#               name: monitoring
#           podSelector:
#             matchLabels:
#               app.kubernetes.io/name: alloy
#       ports:
#         - protocol: TCP
#           port: 8080  # Metrics endpoint
