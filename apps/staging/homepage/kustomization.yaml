apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: homepage
resources:
  - ../../base/homepage
  - ingress.yaml
# Delete the base HTTPRoute since we use Ingress for staging
patches:
  - target:
      kind: HTTPRoute
      name: homepage
    patch: |-
      $patch: delete
      apiVersion: gateway.networking.k8s.io/v1
      kind: HTTPRoute
      metadata:
        name: homepage
  # Update HOMEPAGE_ALLOWED_HOSTS for staging
  - target:
      kind: Deployment
      name: homepage
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/env/0/value
        value: "home.staging.home.lewelly.com"
  # Update ConfigMap services to use staging URLs
  - target:
      kind: ConfigMap
      name: homepage
    patch: |-
      - op: replace
        path: /data/services.yaml
        value: |
          - Home Automation:
              - Home Assistant:
                  icon: home-assistant.png
                  href: https://ha.staging.home.lewelly.com
                  description: Smart home automation
                  ping: ha.staging.home.lewelly.com
              - Code Server:
                  icon: vscode.png
                  href: https://code-server.staging.home.lewelly.com
                  description: Home Assistant config editor

          - Monitoring:
              - Grafana:
                  icon: grafana.png
                  href: https://grafana.staging.home.lewelly.com
                  description: Metrics visualization
                  ping: grafana.staging.home.lewelly.com
              - Prometheus:
                  icon: prometheus.png
                  href: https://prometheus.staging.home.lewelly.com
                  description: Metrics collection
                  ping: prometheus.staging.home.lewelly.com
              - AlertManager:
                  icon: alertmanager.png
                  href: https://alertmanager.staging.home.lewelly.com
                  description: Alert management
                  ping: alertmanager.staging.home.lewelly.com

          - Cluster Management:
              - Kubernetes Dashboard:
                  icon: kubernetes-dashboard.png
                  href: https://k8s.staging.home.lewelly.com
                  description: Kubernetes web UI
                  ping: k8s.staging.home.lewelly.com
              - Headlamp:
                  icon: headlamp.png
                  href: https://headlamp.staging.home.lewelly.com
                  description: Kubernetes IDE
                  ping: headlamp.staging.home.lewelly.com
              - Authelia:
                  icon: authelia.png
                  href: https://auth.staging.home.lewelly.com
                  description: Authentication portal
                  ping: auth.staging.home.lewelly.com

          - Applications:
              - Podinfo:
                  icon: podinfo.png
                  href: https://podinfo.staging.home.lewelly.com
                  description: Test application
                  ping: podinfo.staging.home.lewelly.com
