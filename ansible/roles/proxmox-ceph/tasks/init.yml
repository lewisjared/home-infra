---
# =============================================================================
# Phase 2: Ceph Cluster Initialization (First Monitor Only)
# =============================================================================

- name: Check if Ceph is already initialized
  ansible.builtin.stat:
    path: /etc/pve/ceph.conf
  register: ceph_conf

- name: Initialize Ceph cluster
  ansible.builtin.command:
    cmd: >
      pveceph init
      --network {{ ceph_cluster_network }}
      --cluster-network {{ ceph_cluster_network }}
  when: not ceph_conf.stat.exists

- name: Wait for ceph.conf to be created
  ansible.builtin.wait_for:
    path: /etc/pve/ceph.conf
    state: present
    timeout: 30

# Create bootstrap-osd keyring (required for OSD creation)
- name: Ensure bootstrap-osd directory exists
  ansible.builtin.file:
    path: /var/lib/ceph/bootstrap-osd
    state: directory
    owner: ceph
    group: ceph
    mode: '0755'

- name: Check if bootstrap-osd keyring exists
  ansible.builtin.stat:
    path: /var/lib/ceph/bootstrap-osd/ceph.keyring
  register: bootstrap_keyring

- name: Create bootstrap-osd keyring
  ansible.builtin.shell:
    cmd: |
      ceph auth get-or-create client.bootstrap-osd mon 'allow profile bootstrap-osd' \
        -o /var/lib/ceph/bootstrap-osd/ceph.keyring
      ceph auth get-or-create client.bootstrap-osd \
        -o /etc/pve/priv/ceph.client.bootstrap-osd.keyring
  when: not bootstrap_keyring.stat.exists
