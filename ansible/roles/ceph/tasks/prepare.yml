---
# =============================================================================
# Phase 1: Package Installation and LVM Setup
# =============================================================================

# Ceph Repository Setup (Proxmox No-Subscription)
- name: Add Proxmox Ceph no-subscription repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/ceph.sources
    content: |
      Types: deb
      URIs: http://download.proxmox.com/debian/ceph-{{ ceph_release }}
      Suites: {{ ceph_debian_codename }}
      Components: no-subscription
      Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg
    mode: "0644"
  register: ceph_repo

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  when: ceph_repo.changed

- name: Ensure Ceph packages are installed
  ansible.builtin.apt:
    name:
      - ceph
      - ceph-common
      - ceph-volume
    state: present

# LVM Setup for OSD Storage (Thin LV)
- name: Check if OSD logical volume exists
  ansible.builtin.command:
    cmd: "lvs pve/{{ ceph_osd.lv_name }} --noheadings -o lv_name"
  register: ceph_lv_check
  failed_when: false
  changed_when: false
  when: ceph_osd is defined

- name: Create thin LV for Ceph OSD in data pool
  ansible.builtin.command:
    cmd: "lvcreate -V {{ ceph_osd.lv_size }} -T pve/{{ ceph_osd.thin_pool }} -n {{ ceph_osd.lv_name }}"
  when:
    - ceph_osd is defined
    - ceph_lv_check.rc != 0
